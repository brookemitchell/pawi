# Veterinary Inventory Optimization PoC - Development Checklist

## Phase 0: Setup & Prerequisites

-   [x] Create project directory.
-   [x] Set up Python virtual environment (e.g., `python -m venv venv`).
-   [x] Activate virtual environment.
-   [x] Create `requirements.txt` with `streamlit` and `pandas`.
-   [x] Install requirements: `pip install -r requirements.txt`.
-   [x] Create initial empty files: `app.py`, `data_loader.py`, `simulation.py`.
-   [x] Create SQLite database file: `inventory_poc.db`.
-   [x] Define `inventory_items` table schema in SQLite.
-   [x] Populate (seed) `inventory_items` table in `inventory_poc.db` with the 9 specified items and their parameter values. Verify data accuracy.

## Phase 1: Core Implementation (Stockout PoC)

-   **Prompt 1: Project Setup & Data Loader Foundation**
    -   [x] Implement `data_loader.py`: `load_inventory_data` function.
    -   [x] Include SQLite connection logic.
    -   [x] Include DataFrame creation from query results.
    -   [x] Set `item_name` as index.
    -   [x] Calculate `reorder_point` column.
    -   [x] Calculate `reorder_quantity` column.
    -   [x] Rename `initial_quantity_on_hand` to `quantity_on_hand`.
    -   [x] Ensure function returns the DataFrame.
    -   [x] Implement basic `try...except` for DB errors (return None on failure).
-   **Prompt 2: Basic Streamlit App & Initial Data Display**
    -   [x] Implement basic `app.py` structure.
    -   [x] Import `load_inventory_data`.
    -   [x] Add `st.title`.
    -   [x] Call `load_inventory_data` on app run.
    -   [x] Add check for successful data load (DataFrame is not None).
    -   [x] Display loaded DataFrame using `st.dataframe()`.
    -   [x] Display `st.error()` if data loading failed.
-   **Prompt 3: Introducing State Management**
    -   [x] Modify `app.py` to use `st.session_state`.
    -   [x] Load data into `st.session_state['inventory_df']` only if it doesn't exist.
    -   [x] Handle failed load case by storing `None` in session state.
    -   [x] Initialize `st.session_state['day_count'] = 0` only on first load.
    -   [x] Display DataFrame *from* session state.
    -   [x] Add sidebar metric displaying `st.session_state['day_count']`.
-   **Prompt 4: Implementing the Simulation Logic**
    -   [x] Implement `simulation.py`: `advance_day` function (original version).
    -   [x] Function accepts and returns a DataFrame.
    -   [x] Create a copy of the DataFrame inside the function.
    -   [x] Iterate through rows.
    -   [x] Calculate random consumption using `min/max_daily_usage`.
    -   [x] Calculate `new_qoh` ensuring it's `>= 0`.
    -   [x] Update `quantity_on_hand` in the DataFrame copy.
    -   [x] Return the modified DataFrame copy.
-   **Prompt 5: Connecting Simulation to UI Button**
    -   [x] Modify `app.py`: Import `advance_day` (original).
    -   [x] Define `advance_day_callback()` function (original).
    -   [x] Callback increments `day_count` in session state.
    -   [x] Callback calls `advance_day` using DataFrame from session state.
    -   [x] Callback updates DataFrame in session state with the result.
    -   [x] Add `st.sidebar.button("Advance One Day", ...)` triggering the callback.
-   **Prompt 6: Calculating and Displaying Item Status**
    -   [x] Implement `simulation.py`: `calculate_status` function ("Reorder Needed", "Low Stock", "OK").
    -   [x] Modify `app.py`: Import `calculate_status`.
    -   [x] Modify `app.py`: Define `update_status_column(df)` function (original).
    -   [x] Call `update_status_column` after initial load into session state.
    -   [x] Call `update_status_column` within `advance_day_callback`.
    -   [x] Ensure the displayed DataFrame reflects the `status` column.
-   **Prompt 7: Implementing Order Simulation Logic**
    -   [x] Modify `simulation.py`: Implement `simulate_order` function (original - update QoH).
-   **Prompt 8: Preparing the Order Callback Function**
    -   [x] Modify `app.py`: Import `simulate_order` (original).
    -   [x] Define `simulate_order_callback(item_name)` function (original).
    -   [x] Callback calls `simulate_order`.
    -   [x] Callback calls `update_status_column`.
    -   [x] Callback updates DataFrame in session state.
-   **Prompt 9: Custom Table Rendering**
    -   [x] Modify `app.py`: Replace `st.dataframe` with custom rendering loop.
    -   [x] Add table headers using `st.columns` and `st.markdown`.
    -   [x] Iterate through DataFrame rows (`.iterrows()`).
    -   [x] Use `st.columns()` for each row's layout (original columns).
    -   [x] Display data for Item Name, QoH, ROP, Status (text), Rec. RoQ.
    -   [x] Use `cols[ACTION_INDEX].empty()` as placeholder for Action column.
-   **Prompt 10: Adding Conditional Order Buttons and Status Coloring**
    -   [x] Modify `app.py` rendering loop: Implement status coloring (Red/Orange/Green).
    -   [x] Modify `app.py` rendering loop: Implement conditional action button.
    -   [x] Ensure button uses correct `key`, `on_click`, `args`.
    -   [x] Ensure non-applicable rows have an empty action column.
-   **Prompt 11: Final Polish - Error Handling**
    -   [x] Refine `data_loader.py`: Ensure `try...except` around DB operations (original version).
    -   [x] Refine `app.py`: Ensure initial load logic robustly checks for `None` return and displays `st.error`.

## Phase 2: Testing (Stockout PoC - Manual)

-   [x] Test Initialization
-   [x] Test Simulation (`Advance One Day`)
-   [x] Test Ordering (`Simulate Order`)
-   [x] Test UI/Layout
-   [x] Test Error Handling

## Phase 3: Final Review (Stockout PoC)

-   [x] Code review for clarity, comments, and adherence to structure.
-   [x] Final check against all requirements in the specification document.
-   [x] Ensure `requirements.txt` is accurate.
-   [x] Add a simple `README.md` explaining how to set up and run the PoC.

---

## Phase 4: Expiry Management Feature Implementation

-   **E0: Preparation (Manual DB Changes)**
    -   [x] Backup existing `inventory_items` table.
    -   [x] Create `item_parameters` table (Schema: item_name PK, usage, buffer/target, ROP, RoQ, shelf_life_months).
    -   [x] Create `inventory_batches` table (Schema: batch_id PK AUTOINCREMENT, item_name, quantity_on_hand, expiry_date DATE).
    -   [x] Populate `item_parameters` from backup, adding `standard_shelf_life_months`.
    -   [x] Populate `inventory_batches` with one initial batch per item using original initial QoH and calculated initial expiry date.
-   **E1: Data Model & Foundation Refactor**
    -   **Prompt E1.1: Update Data Loader for New Schema**
        -   [x] Modify `data_loader.py`: Update `load_inventory_data` function.
        -   [x] Query `item_parameters` into `item_params_df`, set index.
        -   [x] Query `inventory_batches` into `batches_df`, set index.
        -   [x] Convert `batches_df['expiry_date']` to datetime objects (`pd.to_datetime`).
        -   [x] Return both `item_params_df, batches_df`.
        -   [x] Update error handling to return `None, None`.
    -   **Prompt E1.2: Adapt App State & Basic Display**
        -   [x] Modify `app.py`: Import `datetime`.
        -   [x] Update initial state check for `'item_params_df'`.
        -   [x] Store `item_params_df` and `batches_df` in session state.
        -   [x] Initialize `st.session_state['current_sim_date']`.
        -   [x] Display `current_sim_date` metric.
        -   [x] Modify main table loop to iterate `item_params_df.index`.
        -   [x] Calculate `total_qoh` from `batches_df` per item.
        -   [x] Display only `Item Name` and `Total QoH` initially.
        -   [x] Comment out/remove previous ROP, Status, RoQ, Action display.
        -   [x] Comment out/disable `advance_day_callback`, `simulate_order_callback` and buttons.
-   **E2: FEFO Consumption**
    -   **Prompt E2.1: Implement FEFO Consumption Logic**
        -   [x] Modify `simulation.py`: Replace `advance_day` function signature.
        -   [x] Implement iteration by item.
        -   [x] Implement random consumption calculation per item.
        -   [x] Filter active, non-expired batches for item.
        -   [x] Sort active batches by `expiry_date`.
        -   [x] Implement consumption loop depleting batches according to FEFO.
        -   [x] Update `quantity_on_hand` in main DataFrame copy.
        -   [x] Remove zero-quantity batches after processing all items.
        -   [x] Return updated `batches_df` copy.
    -   **Prompt E2.2: Integrate FEFO Simulation into App**
        -   [x] Modify `app.py`: Import new `advance_day`.
        -   [x] Re-enable `advance_day_callback()` function.
        -   [x] Update callback to increment `current_sim_date`.
        -   [x] Update callback to call new `advance_day` with correct arguments.
        -   [x] Update callback to store result in `st.session_state['batches_df']`.
        -   [x] Re-enable the "Advance One Day" button.
-   **E3: Batch Receiving Simulation**
    -   **Prompt E3.1: Implement Batch Addition Logic**
        -   [x] Modify `simulation.py`: Replace `simulate_order` with `add_new_batch` function.
        -   [x] Function accepts batches, params, item name, current date.
        -   [x] Get `shelf_life_months` and `reorder_quantity` from params.
        -   [x] Calculate `expiry_date` using `current_sim_date` and `shelf_life_months`.
        -   [x] Create new batch data dictionary/row.
        -   [x] Use `pd.concat` to add the new batch row to DataFrame copy (handle index).
        -   [x] Return updated `batches_df` copy.
    -   **Prompt E3.2: Update Order Callback Function**
        -   [x] Modify `app.py`: Import `add_new_batch`.
        -   [x] Re-enable `simulate_order_callback(item_name)` function.
        -   [x] Update callback to call `add_new_batch` with correct arguments.
        -   [x] Update callback to store result in `st.session_state['batches_df']`.
        -   [x] Keep UI button disabled for now.
-   **E4: Expiry Status Calculation & Alert Display**
    -   **Prompt E4.1: Implement Expiry Status Calculation**
        -   [x] Modify `simulation.py`: Define `ALERT_DAYS_BEFORE_EXPIRY` constant.
        -   [x] Modify `simulation.py`: Create `calculate_expiry_status` function (returns "Expired", "Nearing Expiry", "OK", handles NaT).
        -   [x] Modify `app.py`: Import `calculate_expiry_status`, `ALERT_DAYS_BEFORE_EXPIRY`.
        -   [x] Modify `app.py`: Define `update_expiry_status_column(batches_df)` function.
        -   [x] Call `update_expiry_status_column` after initial load, `advance_day`, and `add_new_batch`.
        -   [x] Ensure result stored back in `st.session_state['batches_df']`.
    -   **Prompt E4.2: Add Expiry Alerts UI Section**
        -   [x] Modify `app.py`: Add `st.subheader("Expiry Alerts")`.
        -   [x] Filter `batches_df` for "Nearing Expiry" or "Expired" statuses.
        -   [x] Display message if filter is empty.
        -   [x] Display filtered alerts data (`item_name`, `quantity_on_hand`, `expiry_date`, `expiry_status`) using `st.dataframe()`. Format date.
-   **E5: UI Integration & Restoration**
    -   **Prompt E5.1: Enhance Main Table with Expiry Summary**
        -   [x] Modify `app.py` main table loop: Calculate `earliest_expiry_date`, `nearing_count`, `expired_count` per item from filtered `batches_df`.
        -   [x] Format `earliest_expiry_date` and create `alert_display` string/icons.
        -   [x] Modify `st.columns` layout to add "Earliest Expiry", "Alerts" columns.
        -   [x] Display calculated summary info in new columns.
        -   [x] Update table headers.
    -   **Prompt E5.2: Restore ROP/Status/Ordering Functionality**
        -   [x] Modify `app.py` main table loop: Import/ensure `calculate_status` exists.
        -   [x] Retrieve item `rop` and `roq` from `item_params_df`.
        -   [x] Calculate overall `item_status` using `total_qoh` and `rop`.
        -   [x] Update `st.columns` layout to include all needed columns (Item Name, Total QoH, ROP, Status(Overall), Earliest Expiry, Alerts, Rec. Order Qty, Action).
        -   [x] Display `rop`.
        -   [x] Display overall `item_status` with color formatting.
        -   [x] Display `roq`.
        -   [x] Re-enable conditional "Simulate Order" button based on `item_status`. Ensure it calls `simulate_order_callback(item_name)`.
        -   [x] Update table headers.

